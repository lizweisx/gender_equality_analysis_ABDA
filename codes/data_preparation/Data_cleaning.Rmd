---
title: "Data Cleaning"
author: "Sixuan Wei"
date: "2024-12-30"
output: html_document
---
# Data Cleaning

In this code, we perform data cleaning for the long format data (applicable to the output file of Extract _data_for_region.rmd).

The main tasks include:

  1. Applying spline interpolation for missing values in Education.Levels;
  2. Applying a logarithmic transformation to GDP data to address the issue of large data range and right-skewed distribution;
  3. Visualizing missing values in Education.Levels and identifying countries with a high proportion of missing values to evaluate their potential impact on the model during analysis.

In addition, education.Levels represents percentage values, but some entries exceed 100%, likely due to multiple enrollment registrations for the same students. In the data cleaning process, we impose a range restriction of 0-100 to prevent out-of-range values from misleading the model. In this model, we focus on analyzing the actual higher education enrollment coverage rate.

- Required R packages: library(ggplot2), library(dplyr), and library(zoo)."

## set up
```{r}
library(dplyr)
library(ggplot2)
library(zoo)
```

```{r read_data}
# Set the path of data
file_path <- "../gender_equality_analysis_ABDA/data/OECD_data_not_cleaned.csv"

data_not_cleaned <- read.csv(file_path)

head(data_not_cleaned)
```
## 1. Handling missing values in education.levels data

### 1.1 Missing Value visualization
```{r mv_counting_by_year}

# Count the number of missing values by year
missing_by_year <- data_not_cleaned %>%
  group_by(Year) %>%
  summarise(Missing_Count = sum(is.na(Education.Levels)))

print(missing_by_year)

ggplot(missing_by_year, aes(x = Year, y = Missing_Count)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Missing Education Levels by Year",
       x = "Year", y = "Number of Missing Values") +
  theme_minimal()
```

```{r mv_counting_by_country}
# Count the number of missing values by country and sort them from most to least.
missing_by_country <- data_not_cleaned %>%
  group_by(Country.Code) %>%
  summarise(Missing_Count = sum(is.na(Education.Levels))) %>%
  arrange(desc(Missing_Count))

print(missing_by_country)

ggplot(missing_by_country, aes(x = reorder(Country.Code, -Missing_Count), y = Missing_Count)) +
  geom_bar(stat = "identity", fill = "lightcoral") +
  labs(title = "Missing Education Levels by Country",
       x = "Country Code", y = "Number of Missing Values") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme_minimal()
```

### 1.2 Handling missing value by spline interpolation
```{r spline-interpolate}

# Interpolate and limit range
data_cleaned <- data_not_cleaned %>%
  group_by(Country.Code) %>%
  mutate(
    # First fill the missing values using spline interpolation
    Education.Levels = na.spline(Education.Levels, na.rm = FALSE),
    
    # Limit interpolation results to the range 0-100
    Education.Levels = pmax(pmin(Education.Levels, 100), 0),
    
    # Values above 100 in the original data are retained as 100
    Education.Levels = ifelse(Education.Levels > 100, 100, Education.Levels)
  ) %>%
  ungroup()


# View the corrected distribution
summary(data_cleaned$Education.Levels)
```


## 2. Handling scale differences and right skew in GDP data
```{r original_GDP_data_distribution}
ggplot(data_cleaned, aes(x = GDP)) +
  geom_histogram(bins = 30, fill = "blue", alpha = 0.7) +
  labs(title = "Distribution of GDP", x = "GDP (US Dollars)", y = "Frequency")

```

```{r log_transform_GDP}
# Log-transform GDP
data_cleaned <- data_cleaned %>%
  mutate(Log.GDP = log(GDP + 1))  # Avoid log(0)

ggplot(data_cleaned, aes(x = Log.GDP)) +
  geom_histogram(bins = 30, fill = "skyblue", alpha = 0.7) +
  labs(title = "Distribution of Log-Transformed GDP", x = "Log(GDP + 1)", y = "Frequency")
```

```{r check_data_integrity}
summary(data_cleaned)
```

## Save the data into csv file
```{r}
# Save the data into csv file
write.csv(data_cleaned, "OECD_data_cleaned.csv", row.names = FALSE)
```